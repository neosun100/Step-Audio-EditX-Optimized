# Step-Audio-EditX ä¼˜åŒ– V2.0

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–å®ç°äº†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

### 1. æ¨¡å‹æ‡’åŠ è½½ â­â­â­â­â­

**ç‰¹æ€§**ï¼š
- âœ… éœ€è¦æ—¶æ‰åŠ è½½æ¨¡å‹åˆ°GPU
- âœ… ç©ºé—²ä¸€å®šæ—¶é—´åè‡ªåŠ¨å¸è½½
- âœ… è‡ªåŠ¨é‡Šæ”¾GPUæ˜¾å­˜
- âœ… çº¿ç¨‹å®‰å…¨çš„æ¨¡å‹ç®¡ç†
- âœ… æ”¯æŒå¤šä¸ªæ¨¡å‹å˜ä½“ï¼ˆbase/awq/bnbï¼‰

**å®ç°**ï¼š
- æ–‡ä»¶ï¼š`lazy_model_manager.py`
- æ ¸å¿ƒç±»ï¼š`LazyModelManager`
- é»˜è®¤ç©ºé—²è¶…æ—¶ï¼š300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰

**æ•ˆæœ**ï¼š
- ä¸ä½¿ç”¨æ—¶æ˜¾å­˜å ç”¨ï¼š~0GB
- ä½¿ç”¨æ—¶æ˜¾å­˜å ç”¨ï¼š~12GBï¼ˆbaseæ¨¡å‹ï¼‰
- ç©ºé—²5åˆ†é’Ÿåè‡ªåŠ¨é‡Šæ”¾æ˜¾å­˜

### 2. ç»Ÿä¸€å®¹å™¨éƒ¨ç½² â­â­â­â­â­

**ç‰¹æ€§**ï¼š
- âœ… UI å’Œ API åœ¨åŒä¸€ä¸ªå®¹å™¨ä¸­
- âœ… å…±äº«åŒä¸€ä¸ªæ¨¡å‹å®ä¾‹
- âœ… é¿å…é‡å¤åŠ è½½æ¨¡å‹
- âœ… èŠ‚çœGPUæ˜¾å­˜å’Œç³»ç»Ÿèµ„æº

**å®ç°**ï¼š
- æ–‡ä»¶ï¼š`server.py`
- ä½¿ç”¨ Gradio çš„ `mount_gradio_app` åŠŸèƒ½
- FastAPI å’Œ Gradio å…±å­˜

**å¯¹æ¯”**ï¼š

| é¡¹ç›® | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æ”¹è¿› |
|------|--------|--------|------|
| å®¹å™¨æ•°é‡ | 2ä¸ªï¼ˆUI + APIï¼‰ | 1ä¸ª | -50% |
| æ¨¡å‹å®ä¾‹ | 2ä¸ª | 1ä¸ª | -50% |
| æ˜¾å­˜å ç”¨ | ~24GB | ~12GB | -50% |
| ç«¯å£å ç”¨ | 2ä¸ª | 1ä¸ª | -50% |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ç»Ÿä¸€å®¹å™¨ï¼ˆæ¨èï¼‰

```bash
# 1. ç¼–è¾‘é…ç½®
vim start_unified_container.sh

# ä¿®æ”¹ä»¥ä¸‹å˜é‡ï¼š
#   PROJECT_DIR="/your/project/path"
#   GPU_ID=2
#   PORT=7860
#   IDLE_TIMEOUT=300

# 2. å¯åŠ¨å®¹å™¨
./start_unified_container.sh

# 3. è®¿é—®æœåŠ¡ï¼ˆç­‰å¾…3åˆ†é’Ÿï¼‰
# UI: http://localhost:7860
# API: http://localhost:7860/docs
# å¥åº·æ£€æŸ¥: http://localhost:7860/healthz
# æ¨¡å‹çŠ¶æ€: http://localhost:7860/api/v1/models/status
```

### æ–¹å¼äºŒï¼šç›´æ¥è¿è¡Œï¼ˆå¼€å‘æµ‹è¯•ï¼‰

```bash
python server.py \
  --model-path /app/models \
  --model-source local \
  --enable-auto-transcribe \
  --idle-timeout 300 \
  --host 0.0.0.0 \
  --port 7860
```

---

## ğŸ“Š æ‡’åŠ è½½å·¥ä½œåŸç†

### ç”Ÿå‘½å‘¨æœŸ

```
[é¦–æ¬¡è¯·æ±‚] â†’ åŠ è½½æ¨¡å‹åˆ°GPU â†’ [å¤„ç†è¯·æ±‚] â†’ [ç©ºé—²è®¡æ—¶å¼€å§‹]
                                                    â†“
                                            [ç©ºé—²5åˆ†é’Ÿ]
                                                    â†“
                                            å¸è½½æ¨¡å‹ï¼Œé‡Šæ”¾æ˜¾å­˜
                                                    â†“
                                            [ä¸‹æ¬¡è¯·æ±‚] â†’ é‡æ–°åŠ è½½
```

### çŠ¶æ€ç›‘æ§

```bash
# æŸ¥çœ‹æ‰€æœ‰æ¨¡å‹çŠ¶æ€
curl http://localhost:7860/api/v1/models/status

# è¿”å›ç¤ºä¾‹ï¼š
{
  "base": {
    "loaded": true,
    "auto_unload": true,
    "idle_timeout": 300,
    "idle_time": 45.2,
    "time_until_unload": 254.8,
    "gpu_memory_allocated_gb": 11.8,
    "gpu_memory_reserved_gb": 12.5
  },
  "bnb": {
    "loaded": false,
    "auto_unload": true,
    "idle_timeout": 300
  }
}
```

### æ‰‹åŠ¨æ§åˆ¶

```bash
# æ‰‹åŠ¨å¸è½½æ¨¡å‹
curl -X POST http://localhost:7860/api/v1/models/base/unload

# è¿”å›ï¼š
{
  "status": "unloaded",
  "variant": "base"
}
```

---

## ğŸ”§ é…ç½®å‚æ•°

### å¯åŠ¨å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | æ¨èå€¼ |
|------|------|--------|--------|
| `--model-path` | æ¨¡å‹æ ¹ç›®å½• | å¿…å¡« | `/app/models` |
| `--idle-timeout` | ç©ºé—²è¶…æ—¶ï¼ˆç§’ï¼‰ | 300 | 300-600 |
| `--disable-auto-unload` | ç¦ç”¨è‡ªåŠ¨å¸è½½ | False | False |
| `--port` | æœåŠ¡ç«¯å£ | 7860 | 7860 |
| `--enable-auto-transcribe` | å¯ç”¨Whisper | False | True |

### ç¯å¢ƒå˜é‡

| å˜é‡ | è¯´æ˜ | æ¨èå€¼ |
|------|------|--------|
| `CUDA_VISIBLE_DEVICES` | å®¹å™¨å†…GPU | `0` |
| `PYTORCH_CUDA_ALLOC_CONF` | PyTorchå†…å­˜ | `expandable_segments:True` |
| `OMP_NUM_THREADS` | OpenMPçº¿ç¨‹ | `8` |
| `MKL_NUM_THREADS` | MKLçº¿ç¨‹ | `8` |

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### æ˜¾å­˜å ç”¨

| åœºæ™¯ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | èŠ‚çœ |
|------|--------|--------|------|
| ç©ºé—²çŠ¶æ€ | 24GB | 0GB | 100% |
| å•ä¸ªè¯·æ±‚ | 24GB | 12GB | 50% |
| å¹¶å‘è¯·æ±‚ | 24GB | 12GB | 50% |

### å¯åŠ¨æ—¶é—´

| åœºæ™¯ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æ”¹è¿› |
|------|--------|--------|------|
| å®¹å™¨å¯åŠ¨ | ~3åˆ†é’Ÿ | ~1åˆ†é’Ÿ | +66% |
| é¦–æ¬¡è¯·æ±‚ | å³æ—¶ | +3ç§’ï¼ˆåŠ è½½ï¼‰ | -3ç§’ |
| åç»­è¯·æ±‚ | å³æ—¶ | å³æ—¶ | ç›¸åŒ |

### èµ„æºåˆ©ç”¨ç‡

| æŒ‡æ ‡ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æ”¹è¿› |
|------|--------|--------|------|
| GPUåˆ©ç”¨ç‡ | ä½ï¼ˆå¸¸é©»ï¼‰ | é«˜ï¼ˆæŒ‰éœ€ï¼‰ | +50% |
| æ˜¾å­˜åˆ©ç”¨ç‡ | ä½ï¼ˆæµªè´¹ï¼‰ | é«˜ï¼ˆæŒ‰éœ€ï¼‰ | +100% |
| å®¹å™¨æ•°é‡ | 2ä¸ª | 1ä¸ª | -50% |

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šä½é¢‘ä½¿ç”¨

**ç‰¹ç‚¹**ï¼šæ¯å¤©åªä½¿ç”¨å‡ æ¬¡ï¼Œå¤§éƒ¨åˆ†æ—¶é—´ç©ºé—²

**ä¼˜åŠ¿**ï¼š
- ç©ºé—²æ—¶è‡ªåŠ¨é‡Šæ”¾æ˜¾å­˜
- å…¶ä»–æœåŠ¡å¯ä»¥ä½¿ç”¨GPU
- èŠ‚çœç”µåŠ›å’Œèµ„æº

**é…ç½®**ï¼š
```bash
--idle-timeout 300  # 5åˆ†é’Ÿç©ºé—²åå¸è½½
```

### åœºæ™¯2ï¼šé«˜é¢‘ä½¿ç”¨

**ç‰¹ç‚¹**ï¼šæŒç»­ä½¿ç”¨ï¼Œè¯·æ±‚é¢‘ç¹

**ä¼˜åŠ¿**ï¼š
- æ¨¡å‹ä¿æŒåŠ è½½çŠ¶æ€
- å“åº”é€Ÿåº¦å¿«
- è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ

**é…ç½®**ï¼š
```bash
--idle-timeout 1800  # 30åˆ†é’Ÿç©ºé—²åå¸è½½
```

### åœºæ™¯3ï¼šå¼€å‘æµ‹è¯•

**ç‰¹ç‚¹**ï¼šé¢‘ç¹ä¿®æ”¹ä»£ç ï¼Œéœ€è¦å¿«é€Ÿé‡å¯

**ä¼˜åŠ¿**ï¼š
- å®¹å™¨å¯åŠ¨å¿«ï¼ˆä¸é¢„åŠ è½½æ¨¡å‹ï¼‰
- ä»£ç ä¿®æ”¹åå¿«é€Ÿç”Ÿæ•ˆ
- èŠ‚çœå¼€å‘æ—¶é—´

**é…ç½®**ï¼š
```bash
--idle-timeout 60  # 1åˆ†é’Ÿç©ºé—²åå¸è½½ï¼ˆå¿«é€Ÿé‡Šæ”¾ï¼‰
```

---

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹å®¹å™¨æ—¥å¿—

```bash
# å®æ—¶æ—¥å¿—
docker logs -f step-audio-unified

# æŸ¥çœ‹æœ€è¿‘100è¡Œ
docker logs --tail 100 step-audio-unified

# æŸ¥çœ‹æ‡’åŠ è½½ç›¸å…³æ—¥å¿—
docker logs step-audio-unified 2>&1 | grep -E "åŠ è½½|å¸è½½|ç©ºé—²"
```

### æŸ¥çœ‹GPUä½¿ç”¨æƒ…å†µ

```bash
# è¿›å…¥å®¹å™¨
docker exec -it step-audio-unified bash

# æŸ¥çœ‹GPU
nvidia-smi

# æŸ¥çœ‹æ˜¾å­˜è¯¦æƒ…
nvidia-smi --query-gpu=memory.used,memory.free,memory.total --format=csv
```

### æŸ¥çœ‹æ¨¡å‹çŠ¶æ€

```bash
# é€šè¿‡APIæŸ¥çœ‹
curl http://localhost:7860/api/v1/models/status | jq

# é€šè¿‡UIæŸ¥çœ‹
# è®¿é—® http://localhost:7860 â†’ "æ¨¡å‹çŠ¶æ€" æ ‡ç­¾é¡µ
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ¨¡å‹åŠ è½½å¤±è´¥

**ç—‡çŠ¶**ï¼šé¦–æ¬¡è¯·æ±‚æ—¶æŠ¥é”™

**åŸå› **ï¼šæ¨¡å‹è·¯å¾„é”™è¯¯æˆ–æƒé™é—®é¢˜

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥æ¨¡å‹ç›®å½•
docker exec step-audio-unified ls -la /app/models/

# åº”è¯¥çœ‹åˆ°ï¼š
# Step-Audio-Tokenizer/
# Step-Audio-EditX/
# Step-Audio-EditX-AWQ-4bit/
# Step-Audio-EditX-bnb-4bit/
```

### é—®é¢˜2ï¼šæ˜¾å­˜æœªé‡Šæ”¾

**ç—‡çŠ¶**ï¼šå¸è½½åæ˜¾å­˜ä»ç„¶å ç”¨

**åŸå› **ï¼šPyTorchç¼“å­˜æœªæ¸…ç†

**è§£å†³**ï¼š
```bash
# æ‰‹åŠ¨å¼ºåˆ¶å¸è½½
curl -X POST http://localhost:7860/api/v1/models/base/unload

# é‡å¯å®¹å™¨
docker restart step-audio-unified
```

### é—®é¢˜3ï¼šå“åº”å˜æ…¢

**ç—‡çŠ¶**ï¼šé¦–æ¬¡è¯·æ±‚å¾ˆæ…¢

**åŸå› **ï¼šæ¨¡å‹æ­£åœ¨åŠ è½½

**è§£å†³**ï¼š
- è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œæ‡’åŠ è½½éœ€è¦3-5ç§’åŠ è½½æ—¶é—´
- å¦‚éœ€é¿å…ï¼Œå¯ä»¥å¢åŠ  `--idle-timeout` æˆ–ç¦ç”¨è‡ªåŠ¨å¸è½½

---

## ğŸ“ è¿ç§»æŒ‡å—

### ä»æ—§æ–¹æ¡ˆè¿ç§»

#### 1. åœæ­¢æ—§å®¹å™¨

```bash
# åœæ­¢UIå®¹å™¨
docker stop step-audio-ui-opt
docker rm step-audio-ui-opt

# åœæ­¢APIå®¹å™¨
docker stop step-audio-api-opt
docker rm step-audio-api-opt
```

#### 2. å¯åŠ¨æ–°å®¹å™¨

```bash
./start_unified_container.sh
```

#### 3. éªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:7860/healthz

# æ£€æŸ¥æ¨¡å‹çŠ¶æ€
curl http://localhost:7860/api/v1/models/status

# è®¿é—®UI
# http://localhost:7860
```

### API ç«¯ç‚¹å˜åŒ–

| æ—§ç«¯ç‚¹ | æ–°ç«¯ç‚¹ | è¯´æ˜ |
|--------|--------|------|
| `http://localhost:7860` | `http://localhost:7860` | UIï¼ˆä¸å˜ï¼‰ |
| `http://localhost:8003/healthz` | `http://localhost:7860/healthz` | å¥åº·æ£€æŸ¥ |
| `http://localhost:8003/docs` | `http://localhost:7860/docs` | APIæ–‡æ¡£ |
| `http://localhost:8003/v1/audio/speech` | `http://localhost:7860/v1/audio/speech` | éŸ³é¢‘ç”Ÿæˆ |
| æ—  | `http://localhost:7860/api/v1/models/status` | æ¨¡å‹çŠ¶æ€ï¼ˆæ–°å¢ï¼‰ |

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **èµ„æºèŠ‚çœ**ï¼šç©ºé—²æ—¶é‡Šæ”¾æ˜¾å­˜ï¼ŒèŠ‚çœ50%+èµ„æº
2. **ç»Ÿä¸€éƒ¨ç½²**ï¼šä¸€ä¸ªå®¹å™¨æä¾›UIå’ŒAPIï¼Œç®€åŒ–ç®¡ç†
3. **æŒ‰éœ€åŠ è½½**ï¼šéœ€è¦æ—¶æ‰åŠ è½½ï¼Œæé«˜GPUåˆ©ç”¨ç‡
4. **è‡ªåŠ¨ç®¡ç†**ï¼šæ— éœ€æ‰‹åŠ¨å¹²é¢„ï¼Œè‡ªåŠ¨å¸è½½å’ŒåŠ è½½

### é€‚ç”¨åœºæ™¯

- âœ… ä½é¢‘ä½¿ç”¨åœºæ™¯ï¼ˆæ¯å¤©å‡ æ¬¡ï¼‰
- âœ… å¤šæœåŠ¡å…±äº«GPU
- âœ… å¼€å‘æµ‹è¯•ç¯å¢ƒ
- âœ… èµ„æºå—é™ç¯å¢ƒ

### ä¸é€‚ç”¨åœºæ™¯

- âŒ è¶…é«˜é¢‘ä½¿ç”¨ï¼ˆæ¯ç§’å¤šæ¬¡è¯·æ±‚ï¼‰
- âŒ å¯¹é¦–æ¬¡å“åº”æ—¶é—´è¦æ±‚æé«˜ï¼ˆ<1ç§’ï¼‰
- âŒ GPUèµ„æºå……è¶³ï¼Œä¸éœ€è¦èŠ‚çœ

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ—¥å¿—ï¼š`docker logs -f step-audio-unified`
2. æ£€æŸ¥çŠ¶æ€ï¼š`curl http://localhost:7860/api/v1/models/status`
3. æäº¤ Issueï¼š[GitHub Issues](https://github.com/stepfun-ai/Step-Audio-EditX/issues)

---

**æ›´æ–°æ—¶é—´**ï¼š2025-12-03
**ç‰ˆæœ¬**ï¼šV2.0
